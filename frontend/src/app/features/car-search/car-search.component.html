<div class="view-header">
  <h1>Buscar Aluguel de Carros</h1>
  <p>Encontre o carro perfeito para sua viagem</p>
</div>

@if (formCollapsed()) {
  <div class="search-toggle-bar" (click)="formCollapsed.set(false)">
    <div class="toggle-info">
      <mat-icon>directions_car</mat-icon>
      <span>Busca de Carros</span>
    </div>
    <div class="toggle-action">
      <span>Editar busca</span>
      <mat-icon>expand_more</mat-icon>
    </div>
  </div>
}

<mat-card class="search-form-card" [class.collapsed]="formCollapsed()">
  <mat-card-content>
    <form [formGroup]="carSearchForm" (ngSubmit)="searchCars()">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Local de Retirada</mat-label>
          <input matInput [formControl]="pickupLocationControl" [matAutocomplete]="autoPickup" />
          <mat-icon matPrefix>location_on</mat-icon>
          <mat-autocomplete #autoPickup [displayWith]="displayLocation">
            @for (loc of filteredPickupLocations$ | async; track loc.id) {
              <mat-option [value]="loc">{{ loc.label }}</mat-option>
            }
          </mat-autocomplete>
          @if (pickupLocationControl.hasError('required')) { <mat-error>Local de retirada é obrigatório</mat-error> }
          @if (pickupLocationControl.hasError('invalidLocation')) { <mat-error>Selecione um local da lista</mat-error> }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Local de Devolução</mat-label>
          <input matInput [formControl]="dropoffLocationControl" [matAutocomplete]="autoDropoff" />
          <mat-icon matPrefix>location_on</mat-icon>
          <mat-autocomplete #autoDropoff [displayWith]="displayLocation">
            @for (loc of filteredDropoffLocations$ | async; track loc.id) {
              <mat-option [value]="loc">{{ loc.label }}</mat-option>
            }
          </mat-autocomplete>
          @if (dropoffLocationControl.hasError('required')) { <mat-error>Local de devolução é obrigatório</mat-error> }
          @if (dropoffLocationControl.hasError('invalidLocation')) { <mat-error>Selecione um local da lista</mat-error> }
        </mat-form-field>
      </div>

      <div class="same-location-row">
        <mat-checkbox (change)="$event.checked ? copyPickupToDropoff() : null">Mesmo local de retirada</mat-checkbox>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Data de Retirada</mat-label>
          <input matInput [matDatepicker]="pickupDatePicker" formControlName="pickupDate" [min]="minPickupDate" />
          <mat-datepicker-toggle matIconSuffix [for]="pickupDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #pickupDatePicker></mat-datepicker>
          @if (carSearchForm.get('pickupDate')?.hasError('required')) { <mat-error>Data de retirada é obrigatória</mat-error> }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Horário de Retirada</mat-label>
          <input matInput type="time" formControlName="pickupTime" />
          <mat-icon matPrefix>schedule</mat-icon>
          @if (carSearchForm.get('pickupTime')?.hasError('required')) { <mat-error>Horário de retirada é obrigatório</mat-error> }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Data de Devolução</mat-label>
          <input matInput [matDatepicker]="dropoffDatePicker" formControlName="dropoffDate" [min]="minDropoffDate" />
          <mat-datepicker-toggle matIconSuffix [for]="dropoffDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #dropoffDatePicker></mat-datepicker>
          @if (carSearchForm.get('dropoffDate')?.hasError('required')) { <mat-error>Data de devolução é obrigatória</mat-error> }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Horário de Devolução</mat-label>
          <input matInput type="time" formControlName="dropoffTime" />
          <mat-icon matPrefix>schedule</mat-icon>
          @if (carSearchForm.get('dropoffTime')?.hasError('required')) { <mat-error>Horário de devolução é obrigatório</mat-error> }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Idade do Motorista</mat-label>
          <input matInput type="number" formControlName="driverAge" min="18" max="99" />
          <mat-icon matPrefix>person</mat-icon>
          @if (carSearchForm.get('driverAge')?.hasError('required')) { <mat-error>Idade do motorista é obrigatória</mat-error> }
          @if (carSearchForm.get('driverAge')?.hasError('min') || carSearchForm.get('driverAge')?.hasError('max')) { <mat-error>Idade deve ser entre 18 e 99</mat-error> }
        </mat-form-field>
      </div>

      @if (isSearching()) {
        <button mat-raised-button color="primary" type="submit" class="search-button" [disabled]="true">
          <mat-spinner diameter="20"></mat-spinner>
          <span>Buscando...</span>
        </button>
      } @else {
        <button mat-raised-button color="primary" type="submit" class="search-button" [disabled]="carSearchForm.invalid">
          <mat-icon>search</mat-icon>
          <span>Buscar Carros</span>
        </button>
      }
    </form>
  </mat-card-content>
</mat-card>

@if (errorMessage()) {
  <app-error-banner [source]="errorSource() ?? 'Carros'" [message]="errorMessage()!" (dismiss)="dismissError()" />
}

@if (searchResults().length > 0) {
  <div class="results-section">
    <div class="results-header">
      <h2>{{ filteredCars().length }} carro{{ filteredCars().length !== 1 ? 's' : '' }} encontrado{{ filteredCars().length !== 1 ? 's' : '' }}</h2>

      <div class="filter-controls">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Tipo de Veículo</mat-label>
          <mat-select (selectionChange)="setVehicleTypeFilter($any($event).value)" [value]="vehicleTypeFilter()">
            <mat-option value="">Todos</mat-option>
            @for (type of vehicleTypes; track type) {
              <mat-option [value]="type">{{ type }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Preço Máximo</mat-label>
          <input matInput type="number" (input)="setMaxPriceFilter($any($event.target).value)" />
          <mat-icon matPrefix>attach_money</mat-icon>
        </mat-form-field>
      </div>
    </div>

    @for (car of filteredCars(); track car.id) {
      <mat-card class="result-card">
        <div class="card-layout">
          <div class="card-image">
            @if (car.images && car.images.length > 0) {
              <img [src]="car.images[0]" [alt]="car.vehicleType" loading="lazy" />
            } @else {
              <div class="image-placeholder"><mat-icon>directions_car</mat-icon></div>
            }
          </div>

          <div class="card-info">
            <h3 class="item-name">{{ car.vehicleType }}</h3>
            <div class="item-detail">
              <mat-icon>flight_takeoff</mat-icon>
              <span>Retirada: {{ car.pickUpLocation }} - {{ car.pickUpAt }}</span>
            </div>
            <div class="item-detail">
              <mat-icon>flight_land</mat-icon>
              <span>Devolução: {{ car.dropOffLocation }} - {{ car.dropOffAt }}</span>
            </div>
          </div>

          <div class="card-price-column">
            <div class="price-block">
              <span class="price-amount">{{ car.price.total | currency: 'BRL' }}</span>
              <span class="price-label">total</span>
            </div>
            <button mat-raised-button color="primary" class="action-btn" (click)="addToItinerary(car)">
              <mat-icon>add</mat-icon> Adicionar
            </button>
            <a mat-stroked-button class="action-btn detail-btn" [href]="car.link.url" target="_blank" rel="noopener noreferrer">
              Ver detalhe
            </a>
          </div>
        </div>
      </mat-card>
    }
  </div>
}

@if (searchResults().length === 0 && !isSearching() && hasSearched()) {
  <mat-card class="empty-state">
    <mat-card-content>
      <mat-icon>directions_car</mat-icon>
      <p>Nenhum carro encontrado. Tente outros locais ou datas.</p>
    </mat-card-content>
  </mat-card>
}
