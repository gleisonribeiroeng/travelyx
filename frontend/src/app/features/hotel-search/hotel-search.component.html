<div class="view-header">
  <h1>Buscar Hotéis</h1>
  <p>Encontre a hospedagem perfeita para sua viagem</p>
</div>

@if (formCollapsed()) {
  <div class="search-toggle-bar" (click)="formCollapsed.set(false)">
    <div class="toggle-info">
      <mat-icon>hotel</mat-icon>
      <span>Busca de Hotéis</span>
    </div>
    <div class="toggle-action">
      <span>Editar busca</span>
      <mat-icon>expand_more</mat-icon>
    </div>
  </div>
}

<mat-card class="search-form-card" [class.collapsed]="formCollapsed()">
  <mat-card-content>
    <form [formGroup]="hotelSearchForm" (ngSubmit)="searchHotels()">
      <!-- Destination Row -->
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Destino</mat-label>
          <input
            matInput
            [formControl]="destinationControl"
            [matAutocomplete]="autoDestination"
          />
          <mat-icon matPrefix>location_on</mat-icon>
          <mat-autocomplete #autoDestination [displayWith]="displayDestination">
            @for (dest of filteredDestinations$ | async; track dest.destId) {
              <mat-option [value]="dest">
                {{ dest.label }}
              </mat-option>
            }
          </mat-autocomplete>
          @if (destinationControl.hasError('required')) {
            <mat-error>Destino é obrigatório</mat-error>
          }
          @if (destinationControl.hasError('invalidDestination')) {
            <mat-error>Selecione um destino da lista</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Check-in and Check-out Row -->
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Check-in</mat-label>
          <input
            matInput
            [matDatepicker]="checkInPicker"
            formControlName="checkIn"
            [min]="minCheckInDate"
          />
          <mat-datepicker-toggle matIconSuffix [for]="checkInPicker"></mat-datepicker-toggle>
          <mat-datepicker #checkInPicker></mat-datepicker>
          @if (hotelSearchForm.get('checkIn')?.hasError('required')) {
            <mat-error>Data de check-in é obrigatória</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Check-out</mat-label>
          <input
            matInput
            [matDatepicker]="checkOutPicker"
            formControlName="checkOut"
            [min]="minCheckOutDate"
          />
          <mat-datepicker-toggle matIconSuffix [for]="checkOutPicker"></mat-datepicker-toggle>
          <mat-datepicker #checkOutPicker></mat-datepicker>
          @if (hotelSearchForm.get('checkOut')?.hasError('required')) {
            <mat-error>Data de check-out é obrigatória</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Guests and Rooms Row -->
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Hóspedes</mat-label>
          <mat-select formControlName="guests">
            @for (num of [1, 2, 3, 4, 5, 6, 7, 8]; track num) {
              <mat-option [value]="num">{{ num }} {{ num === 1 ? 'Hóspede' : 'Hóspedes' }}</mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>person</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Quartos</mat-label>
          <mat-select formControlName="rooms">
            @for (num of [1, 2, 3, 4, 5]; track num) {
              <mat-option [value]="num">{{ num }} {{ num === 1 ? 'Quarto' : 'Quartos' }}</mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>hotel</mat-icon>
        </mat-form-field>
      </div>

      <!-- Submit Button -->
      @if (isSearching()) {
        <button
          mat-raised-button
          color="primary"
          type="submit"
          class="search-button"
          [disabled]="true"
        >
          <mat-spinner diameter="20"></mat-spinner>
          <span>Buscando...</span>
        </button>
      } @else {
        <button
          mat-raised-button
          color="primary"
          type="submit"
          class="search-button"
          [disabled]="hotelSearchForm.invalid"
        >
          <mat-icon>search</mat-icon>
          <span>Buscar Hotéis</span>
        </button>
      }
    </form>
  </mat-card-content>
</mat-card>

<!-- Error Banner -->
@if (errorMessage()) {
  <app-error-banner
    [source]="errorSource() ?? 'Hotéis'"
    [message]="errorMessage()!"
    (dismiss)="dismissError()"
  />
}

<!-- Results Section -->
@if (searchResults().length > 0) {
  <!-- Highlight Cards -->
  @if (categorized().cheapest || categorized().bestRated || categorized().bestValue) {
    <div class="highlights-strip">
      @if (categorized().cheapest; as cheapest) {
        <div class="hl-card hl-cheap" (click)="addToItinerary(cheapest)">
          <div class="hl-badge"><mat-icon>savings</mat-icon> Melhor Preço</div>
          <div class="hl-name">{{ cheapest.name }}</div>
          <div class="hl-info">
            {{ cheapest.address }}
            @if (cheapest.rating) {
              · <mat-icon class="hl-star">star</mat-icon> {{ cheapest.rating.toFixed(1) }}
            }
          </div>
          <div class="hl-price">{{ cheapest.pricePerNight.total | currency: 'BRL' }}<span class="hl-price-label">/noite</span></div>
        </div>
      }
      @if (categorized().bestRated; as rated) {
        <div class="hl-card hl-rated" (click)="addToItinerary(rated)">
          <div class="hl-badge"><mat-icon>star</mat-icon> Mais Bem Avaliado</div>
          <div class="hl-name">{{ rated.name }}</div>
          <div class="hl-info">
            {{ rated.address }}
            @if (rated.rating) {
              · <mat-icon class="hl-star">star</mat-icon> {{ rated.rating.toFixed(1) }}
            }
            @if (rated.reviewCount > 0) {
              ({{ rated.reviewCount }})
            }
          </div>
          <div class="hl-price">{{ rated.pricePerNight.total | currency: 'BRL' }}<span class="hl-price-label">/noite</span></div>
        </div>
      }
      @if (categorized().bestValue; as best) {
        <div class="hl-card hl-value" (click)="addToItinerary(best)">
          <div class="hl-badge"><mat-icon>auto_awesome</mat-icon> Melhor Custo-Benefício</div>
          <div class="hl-name">{{ best.name }}</div>
          <div class="hl-info">
            {{ best.address }}
            @if (best.rating) {
              · <mat-icon class="hl-star">star</mat-icon> {{ best.rating.toFixed(1) }}
            }
          </div>
          <div class="hl-price">{{ best.pricePerNight.total | currency: 'BRL' }}<span class="hl-price-label">/noite</span></div>
        </div>
      }
    </div>
  }

  <div class="results-section">
    <div class="results-header">
      <h2>{{ sortedHotels().length }} hotéis encontrados</h2>

      <!-- Sort Dropdown -->
      <mat-form-field appearance="outline" class="sort-field">
        <mat-label>Ordenar por</mat-label>
        <mat-select (selectionChange)="setSortBy($any($event).value)" [value]="sortBy()">
          <mat-option value="price">Preço (menor)</mat-option>
          <mat-option value="rating">Avaliação (melhor)</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Hotel Result Cards (Decolar-style 3-column) -->
    @for (hotel of sortedHotels(); track hotel.id) {
      <mat-card class="hotel-card">
        <!-- Tags -->
        @if (categorized().cheapest?.id === hotel.id || categorized().bestRated?.id === hotel.id || categorized().bestValue?.id === hotel.id) {
          <div class="hotel-tags">
            @if (categorized().bestValue?.id === hotel.id) {
              <span class="htag htag-value">Melhor custo-benefício</span>
            }
            @if (categorized().cheapest?.id === hotel.id) {
              <span class="htag htag-cheap">Melhor preço</span>
            }
            @if (categorized().bestRated?.id === hotel.id) {
              <span class="htag htag-rated">Mais bem avaliado</span>
            }
          </div>
        }
        <div class="hotel-card-layout">
          <!-- Left: Image Carousel -->
          <div class="hotel-carousel">
            <img
              [src]="getCurrentImage(hotel)"
              [alt]="hotel.name"
              class="carousel-image"
              loading="lazy"
            />
            @if (hotel.images && hotel.images.length > 1) {
              <button class="carousel-btn prev" (click)="prevImage(hotel, $event)">
                <mat-icon>chevron_left</mat-icon>
              </button>
              <button class="carousel-btn next" (click)="nextImage(hotel, $event)">
                <mat-icon>chevron_right</mat-icon>
              </button>
              <div class="carousel-dots">
                @for (img of hotel.images; track $index) {
                  <span class="dot" [class.active]="$index === getImageIndex(hotel.id)"></span>
                }
              </div>
            }
          </div>

          <!-- Center: Hotel Info -->
          <div class="hotel-info">
            <h3 class="hotel-name">{{ hotel.name }}</h3>

            <div class="hotel-location">
              <mat-icon>location_on</mat-icon>
              <span>{{ hotel.address }}</span>
            </div>

            <div class="hotel-rating">
              @for (star of renderStars(hotel.rating); track $index) {
                <mat-icon class="star-icon">{{ star }}</mat-icon>
              }
              <span class="rating-text">{{ formatRating(hotel.rating) }}</span>
              @if (hotel.reviewCount > 0) {
                <span class="review-count-text">({{ hotel.reviewCount }} avaliações)</span>
              }
            </div>

            <div class="hotel-dates">
              <mat-icon>date_range</mat-icon>
              <span>{{ hotel.checkIn }} — {{ hotel.checkOut }}</span>
            </div>
          </div>

          <!-- Right: Price + Actions -->
          <div class="hotel-price-column">
            <div class="price-block">
              <span class="price-amount">{{ hotel.pricePerNight.total | currency: 'BRL' }}</span>
              <span class="price-label">/noite</span>
            </div>

            <button mat-raised-button color="primary" class="action-btn" (click)="addToItinerary(hotel)">
              <mat-icon>add</mat-icon>
              Adicionar
            </button>

            <a
              mat-stroked-button
              class="action-btn detail-btn"
              [href]="hotel.link.url"
              target="_blank"
              rel="noopener noreferrer"
            >
              Ver detalhe
            </a>
          </div>
        </div>
      </mat-card>
    }
  </div>
}

<!-- Empty State -->
@if (searchResults().length === 0 && !isSearching() && hasSearched()) {
  <mat-card class="empty-state">
    <mat-card-content>
      <mat-icon>hotel</mat-icon>
      <p>Nenhum hotel encontrado. Tente um destino ou datas diferentes.</p>
    </mat-card-content>
  </mat-card>
}
